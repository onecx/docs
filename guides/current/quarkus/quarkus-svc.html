<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Backend service (svc) :: OneCX Docs</title>
    <link rel="canonical" href="https://onecx.github.io/docs/guides/current/quarkus/quarkus-svc.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js/dist/assets/bpmn-font/css/bpmn.css">
    <link rel="stylesheet" href="../../../_/css/bpmn.css">
    <link href="../../../_/css/fontawesome.css" rel="stylesheet" />
    <link href="../../../_/css/brands.css" rel="stylesheet" />
    <link href="../../../_/css/solid.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui.css">
    <script>var uiRootPath = '../../../_'</script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/bpmn-js/dist/bpmn-viewer.production.min.js"></script>
    <script src="https://unpkg.com/dmn-js@11.0.2/dist/dmn-viewer.production.min.js"></script>
    <script src="../../../_/js/bpmn.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui-standalone-preset.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui-bundle.js"></script>

  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://onecx.github.io/docs">OneCX Docs</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="/docs">Home</a>
        <!--  <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Guides</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="/docs/docs-guides-quarkus/latest/">Quarkus</a>
            <a class="navbar-item" href="/docs/docs-guides-bpmn/latest/">Bpmn</a>
          </div> 
        </div> -->
        <div class="navbar-item">
          <span class="control">
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="guides" data-version="latest">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../general/index.html">Guides</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../general/index.html">General</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Documentation</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Setup</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../documentation/setup/product.html">Create new product</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../documentation/setup/repository.html">Integrating new repository</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Angular</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../angular/general/index.html">General</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../angular/general/guidelines.html">Guidelines</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <span class="nav-text">Cookbook</span>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../angular/ngrx/ngrx.html">NgRx</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Libraries</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../angular/libraries/symlink.html">How to create a SymLink</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../angular/libraries/workingWithSharedLibraries.html">Working with shared libraries</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Quarkus</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="project-structure.html">Project structure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quarkus-github-actions.html">Project GitHub Actions</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quarkus-rest-api.html">Rest API CRUD Guidelines</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="quarkus-svc.html">Backend service (svc)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quarkus-bff.html">Backend from frontends (bff)</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="quarkus-operator.html">K8s operator (operator)</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">BPMN</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bpmn/cancel-timer.html">Cancel timer</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bpmn/request-callback.html">Request callback</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bpmn/messages.html">Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../bpmn/open-topics.html">Open topics</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Guides</span>
    <span class="version">latest</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../../onecx-announcement/current/general/index.html">Announcement Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-announcement/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-bookmark/current/general/index.html">Bookmark Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-bookmark/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-document-management/current/onecx-document-management/index.html">Document Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-document-management/current/onecx-document-management/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../general/index.html">Guides</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-help/current/general/index.html">Help Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-help/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-iam/current/general/index.html">IAM Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-iam/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../index/current/index.html">OneCX Docs</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../index/current/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../nx-plugins/current/general/index.html">OneCX generator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../nx-plugins/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-quarkus/current/onecx-quarkus/index.html">Onecx Quarkus</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-quarkus/current/onecx-quarkus/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-parameter/current/general/index.html">Parameter Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-parameter/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-permission/current/general/index.html">Permission Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-permission/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-product-store/current/general/index.html">Product Store Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-product-store/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-tenant/current/general/index.html">Tenant Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-tenant/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-theme/current/general/index.html">Theme Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-theme/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-user-profile/current/general/index.html">User Profile Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-user-profile/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-welcome/current/general/index.html">Welcome Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-welcome/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../onecx-workspace/current/general/index.html">Workspace Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../onecx-workspace/current/general/index.html">latest</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../index/current/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../general/index.html">Guides</a></li>
    <li>Quarkus</li>
    <li><a href="quarkus-svc.html">Backend service (svc)</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/onecx/docs-guides-quarkus/edit/main/docs/modules/quarkus/pages/quarkus-svc.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
      <h1 class="page">Backend service (svc)</h1>
    <div class="sect1">
<h2 id="_project_setup"><a class="anchor" href="#_project_setup"></a>Project setup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now that <a href="project-structure.html" class="xref page">project structure</a> is set up for the Onecx Quarkus project, we can configure the backend service and extend the project configuration.</p>
</div>
<div class="sect2">
<h3 id="_parent_configuration"><a class="anchor" href="#_parent_configuration"></a>Parent configuration</h3>
<div class="paragraph">
<p>Project maven parent configuration, artifactId and project version.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
More information about maven parent pom pattern <a href="https://maven.apache.org/guides/introduction/introduction-to-the-pom.html">Apache Maven Pom Documentation</a>
</td>
</tr>
</table>
</div>
<details open>
<summary class="title">Maven parent configuration</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;parent&gt;
        &lt;groupId&gt;org.tkit.onecx&lt;/groupId&gt;
        &lt;artifactId&gt;onecx-quarkus3-parent&lt;/artifactId&gt;
        &lt;version&gt;0.62.0&lt;/version&gt;
    &lt;/parent&gt;

    &lt;artifactId&gt;onecx-example-svc&lt;/artifactId&gt;
    &lt;version&gt;999-SNAPSHOT&lt;/version&gt;

&lt;/project&gt;</code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_dependencies"><a class="anchor" href="#_dependencies"></a>Dependencies</h3>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
All version of the dependencies are defined in the <code>onecx-quarkus3-parent</code>. Project itself should not define any version of these dependencies.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By default, we will have the following maven dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://1000kit.github.io/tkit-quarkus/current/tkit-quarkus/index.html">tkit-quarkus</a> are quarkus extensions for <code>JPA</code>, <code>log</code>, <code>json-log</code> and <code>rest-log</code></p>
</li>
<li>
<p><a href="https://quarkus.io/guides/">quarkus</a> cloud native extensions (health, metrics, tracing, &#8230;&#8203;), quarkus-rest, hibernate-orm and liquibase</p>
</li>
<li>
<p><a href="https://projectlombok.org/">lombok</a> to generate getters, setters and much more</p>
</li>
<li>
<p><a href="https://mapstruct.org/documentation/stable/reference/html/">mapstruct</a> Generator to generate a source that maps <code>DTO</code> to <code>JPA</code> models and vice versa</p>
</li>
</ul>
</div>
<details>
<summary class="title">Backend service default dependencies</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
        &lt;!-- ONECX --&gt;

        &lt;!-- 1000kit --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-rest-context&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-jpa&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-log-cdi&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-log-rs&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-log-json&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-rest&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- QUARKUS --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-arc&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-liquibase&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.github.blagerweij&lt;/groupId&gt;
            &lt;artifactId&gt;liquibase-sessionlock&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-micrometer-registry-prometheus&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-hibernate-orm&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-resteasy-reactive&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-resteasy-reactive-jackson&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-jdbc-postgresql&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-smallrye-context-propagation&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-smallrye-openapi&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-hibernate-validator&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;quarkus-opentelemetry&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!-- OTHER --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;
            &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;
        &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_generate_rest_endpoint"><a class="anchor" href="#_generate_rest_endpoint"></a>Generate rest endpoint</h3>
<div class="paragraph">
<p>In <code>onecx</code> project we do use API-first approach. First we need to defined our <code>REST</code> interface with <code>openApi</code>. Create a <code>example-v1.yaml</code> (pattern: &lt;application&gt;-&lt;version&gt;.yaml) in the <code>src/main/openapi</code> directory.</p>
</div>
<details>
<summary class="title">Example openapi file</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">openapi: 3.0.3
info:
  title: example service
  version: 1.0.0
servers:
  - url: "http://onecx-example-svc:8080"
paths:
  /internal/roles:
    post:
      operationId: createRole
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleRequest'
      responses:
        201:
          description: New role created
          headers:
            Location:
              required: true
              schema:
                type: string
                format: url
        400:
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProblemDetailResponse'
components:
  schemas:
    CreateRoleRequest:
      type: object
      properties:
        name:
          type: string
        shortDescription:
          type: string
        description:
          type: string
    ProblemDetailResponse:
      type: object
      properties:
        errorCode:
          type: string
        detail:
          type: string
        params:
          type: array
          items:
            $ref: '#/components/schemas/ProblemDetailParam'
        invalidParams:
          type: array
          items:
            $ref: '#/components/schemas/ProblemDetailInvalidParam'
    ProblemDetailParam:
      type: object
      properties:
        key:
          type: string
        value:
          type: string
    ProblemDetailInvalidParam:
      type: object
      properties:
        name:
          type: string
        message:
          type: string</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Now we can configure <code>org.tkit.onecx.quarkus:onecx-openapi-generator</code> Maven plugin. The important part of the Maven plugin configuration is:</p>
</div>
<details open>
<summary class="title">OpenApi generator Maven plugin configuration for Quarkus</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;configuration&gt;
    &lt;generatorName&gt;jaxrs-spec&lt;/generatorName&gt;
    &lt;modelNameSuffix&gt;DTO&lt;/modelNameSuffix&gt;
    &lt;generateApiTests&gt;false&lt;/generateApiTests&gt;
    &lt;generateApiDocumentation&gt;false&lt;/generateApiDocumentation&gt;
    &lt;generateModelTests&gt;false&lt;/generateModelTests&gt;
    &lt;generateModelDocumentation&gt;false&lt;/generateModelDocumentation&gt;
    &lt;generateSupportingFiles&gt;false&lt;/generateSupportingFiles&gt;
    &lt;addCompileSourceRoot&gt;true&lt;/addCompileSourceRoot&gt;
    &lt;!-- Quarkus open-api generator library --&gt;
    &lt;library&gt;quarkus&lt;/library&gt;
    &lt;configOptions&gt;
        &lt;sourceFolder&gt;/&lt;/sourceFolder&gt;
        &lt;openApiNullable&gt;false&lt;/openApiNullable&gt;
        &lt;returnResponse&gt;true&lt;/returnResponse&gt;
        &lt;useTags&gt;true&lt;/useTags&gt;
        &lt;interfaceOnly&gt;true&lt;/interfaceOnly&gt;
        &lt;serializableModel&gt;true&lt;/serializableModel&gt;
        &lt;singleContentTypes&gt;true&lt;/singleContentTypes&gt;
        &lt;dateLibrary&gt;java8&lt;/dateLibrary&gt;
        &lt;useMicroProfileOpenAPIAnnotations&gt;true&lt;/useMicroProfileOpenAPIAnnotations&gt;
        &lt;!-- required for Quarkus 3 --&gt;
        &lt;useJakartaEe&gt;true&lt;/useJakartaEe&gt;
        &lt;!-- enabled DTO validation --&gt;
        &lt;useBeanValidation&gt;true&lt;/useBeanValidation&gt;
        &lt;java17&gt;true&lt;/java17&gt;
    &lt;/configOptions&gt;
&lt;/configuration&gt;</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">OpenApi generator full Maven plugin configuration</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;build&gt;
    &lt;plugins&gt;
        &lt;plugin&gt;
            &lt;groupId&gt;org.openapitools&lt;/groupId&gt;
            &lt;artifactId&gt;openapi-generator-maven-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
                &lt;generatorName&gt;jaxrs-spec&lt;/generatorName&gt;
                &lt;modelNameSuffix&gt;DTO&lt;/modelNameSuffix&gt;
                &lt;generateApiTests&gt;false&lt;/generateApiTests&gt;
                &lt;generateApiDocumentation&gt;false&lt;/generateApiDocumentation&gt;
                &lt;generateModelTests&gt;false&lt;/generateModelTests&gt;
                &lt;generateModelDocumentation&gt;false&lt;/generateModelDocumentation&gt;
                &lt;generateSupportingFiles&gt;false&lt;/generateSupportingFiles&gt;
                &lt;addCompileSourceRoot&gt;true&lt;/addCompileSourceRoot&gt;
                &lt;library&gt;quarkus&lt;/library&gt;
                &lt;configOptions&gt;
                    &lt;sourceFolder&gt;/&lt;/sourceFolder&gt;
                    &lt;openApiNullable&gt;false&lt;/openApiNullable&gt;
                    &lt;returnResponse&gt;true&lt;/returnResponse&gt;
                    &lt;useTags&gt;true&lt;/useTags&gt;
                    &lt;interfaceOnly&gt;true&lt;/interfaceOnly&gt;
                    &lt;serializableModel&gt;true&lt;/serializableModel&gt;
                    &lt;singleContentTypes&gt;true&lt;/singleContentTypes&gt;
                    &lt;dateLibrary&gt;java8&lt;/dateLibrary&gt;
                    &lt;useMicroProfileOpenAPIAnnotations&gt;true&lt;/useMicroProfileOpenAPIAnnotations&gt;
                    &lt;useJakartaEe&gt;true&lt;/useJakartaEe&gt;
                    &lt;useBeanValidation&gt;true&lt;/useBeanValidation&gt;
                    &lt;java17&gt;true&lt;/java17&gt;
                &lt;/configOptions&gt;
            &lt;/configuration&gt;
            &lt;executions&gt;
                &lt;execution&gt;
                    &lt;id&gt;v1&lt;/id&gt;
                    &lt;goals&gt;
                        &lt;goal&gt;generate&lt;/goal&gt;
                    &lt;/goals&gt;
                    &lt;configuration&gt;
                        &lt;inputSpec&gt;src/main/openapi/onecx-example-v1.yaml&lt;/inputSpec&gt;
                        &lt;apiPackage&gt;gen.org.tkit.onecx.example.rs.v1&lt;/apiPackage&gt;
                        &lt;modelPackage&gt;gen.org.tkit.onecx.example.rs.v1.model&lt;/modelPackage&gt;
                        &lt;modelNameSuffix&gt;DTO&lt;/modelNameSuffix&gt;
                    &lt;/configuration&gt;
                &lt;/execution&gt;
            &lt;/executions&gt;
        &lt;/plugin&gt;
    &lt;/plugins&gt;
&lt;/build&gt;</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>After we run <code>mvn clean package</code> maven plugin will generate in corresponding source code in <code>target/generated-sources</code> directory.</p>
</div>
</div>
<div class="sect2">
<h3 id="_rest_implementation"><a class="anchor" href="#_rest_implementation"></a>REST Implementation</h3>
<div class="paragraph">
<p>To implement the <code>RoleRestController</code> we need to create a java class which implements generated interface <code>gen.org.tkit.onecx.example.rs.v1.RoleInternalApi</code>.</p>
</div>
<details>
<summary class="title">RoleRestController</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import jakarta.enterprise.context.ApplicationScoped;
import jakarta.ws.rs.core.Response;
import jakarta.validation.ConstraintViolationException;
import org.tkit.quarkus.jpa.exceptions.ConstraintException;
import jakarta.persistence.OptimisticLockException;

import gen.org.tkit.onecx.example.rs.v1.RoleInternalApi;
import gen.org.tkit.onecx.example.rs.v1.model.CreateRoleRequestDTO;

@ApplicationScoped
public class RoleRestController implements RoleInternalApi {

    @Inject
    RoleMapper mapper;

    @Inject
    ExceptionMapper exceptionMapper;

    @Context
    UriInfo uriInfo;

    @Override
    public Response createRole(CreateRoleRequestDTO createRoleRequestDTO) {
        var role = mapper.create(createRoleRequestDTO);
        role = dao.create(role);
        return Response
                .created(uriInfo.getAbsolutePathBuilder().path(role.getId()).build())
                .entity(mapper.map(theme))
                .build();
    }

    // constraint exception exception handler
    @ServerExceptionMapper
    public RestResponse&lt;ProblemDetailResponseDTO&gt; exception(ConstraintException ex) {
        return exceptionMapper.exception(ex);
    }

    // constraint violation exception handler
    @ServerExceptionMapper
    public RestResponse&lt;ProblemDetailResponseDTO&gt; constraint(ConstraintViolationException ex) {
        return exceptionMapper.constraint(ex);
    }

    // Optimistic lock exception handler
    @ServerExceptionMapper
    public RestResponse&lt;ProblemDetailResponseDTO&gt; optimisticLockException(OptimisticLockException ex) {
        return exceptionMapper.optimisticLock(ex);
    }

}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>For the backend service we need to define exception mapper methods for following exception:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>jakarta.persistence.OptimisticLockException</code> - this exception is throw when try to store object in the database with old or wrong <code>OPTLOCK</code> number.</p>
</li>
<li>
<p><code>jakarta.validation.ConstraintViolationException</code> - when we activate a validation framework <code>io.quarkus:quarkus-hibernate-validator</code> this exception will be thrown when request does not match to the requirements defined in the OpenApi.</p>
</li>
<li>
<p><code>org.tkit.quarkus.jpa.exceptions.ConstraintException</code> - this exception will be thrown for any database constraints.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
With the annotation <code>@ServerExceptionMapper</code> we defined the exception mapper for each <code>Exception</code> in the context of the RestController.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To map the request <code>DTO</code> object to the <code>JPA</code> model we use the <code>Mapstruct</code>. We define the <code>RoleMapper</code> in our example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.tkit.quarkus.rs.mappers.OffsetDateTimeMapper;

@Mapper(uses = { OffsetDateTimeMapper.class })
public interface RoleMapper {

    @Mapping(target = "id", ignore = true)
    @Mapping(target = "creationDate", ignore = true)
    @Mapping(target = "creationUser", ignore = true)
    @Mapping(target = "modificationDate", ignore = true)
    @Mapping(target = "modificationUser", ignore = true)
    @Mapping(target = "controlTraceabilityManual", ignore = true)
    @Mapping(target = "modificationCount", ignore = true)
    @Mapping(target = "persisted", ignore = true)
    @Mapping(target = "tenantId", ignore = true)
    Role create(CreateRoleRequestDTO dto);

    // ... more mapping methods
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same approach we use for the exception mapper which could be shared between multiple <code>RestController</code> for the same rest interface.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.tkit.quarkus.rs.mappers.OffsetDateTimeMapper;

@Mapper(uses = { OffsetDateTimeMapper.class })
public interface ExceptionMapper {

    default RestResponse&lt;ProblemDetailResponseDTO&gt; constraint(ConstraintViolationException ex) {
        var dto = exception(ErrorKeys.CONSTRAINT_VIOLATIONS.name(), ex.getMessage());
        dto.setInvalidParams(createErrorValidationResponse(ex.getConstraintViolations()));
        return RestResponse.status(Response.Status.BAD_REQUEST, dto);
    }

    //.... more mapping methods
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>org.tkit.quarkus.rs.mappers.OffsetDateTimeMapper</code> mapper is predefined a mapstruct mapper for <code>OffsetDateTime</code> and <code>LocalDateTime</code> object.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_layer_implementation"><a class="anchor" href="#_jpa_layer_implementation"></a>JPA layer implementation</h3>
<div class="paragraph">
<p>For our project we will use the <code>tkit-quarkus-jpa</code> and <code>tkit-quarkus-jpa-models</code> extension for Quarkus which have simple API on top of JPA. We have abstract <code>DAO</code> classes and abstract Entity classes which provides basic <code>CRUD</code> operation. For more information please read the extension <a href="https://1000kit.github.io/tkit-quarkus/current/tkit-quarkus/index.html">tkit-quarkus-jpa</a> documentation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
    &lt;artifactId&gt;tkit-quarkus-jpa&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create User entity class in the <code>org.tkit.onecx.user.domain.models</code> package. The entity class extend the <code>TraceableEntity</code>. In the entity class can use the Lombok annotation <code>@Getter</code> and <code>@Setter</code> to generate the getters and setters.</p>
</div>
<details open>
<summary class="title">Example user entity</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.persistence.Entity;
import javax.persistence.Table;
import org.tkit.quarkus.jpa.models.TraceableEntity;

@Entity
@Table(name = "T_USER")
public class User extends TraceableEntity {

    @Column(name = "USERNAME")
    private String username;
}</code></pre>
</div>
</div>
</div>
</details>
<details open>
<summary class="title">Example user DAO</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.tkit.quarkus.jpa.daos.AbstractDAO;
import javax.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class UserDAO extends AbstractDAO&lt;User&gt; {

}</code></pre>
</div>
</div>
</div>
</details>
<div class="sect3">
<h4 id="_database_configuration"><a class="anchor" href="#_database_configuration"></a>Database configuration</h4>
<div class="paragraph">
<p>In <code>onecx</code> project we do use the <code>postgresql</code> database for our backend services.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.datasource.db-kind=postgresql
quarkus.datasource.jdbc.max-size=30
quarkus.datasource.jdbc.min-size=10

quarkus.hibernate-orm.database.generation=validate
quarkus.hibernate-orm.jdbc.timezone=UTC
quarkus.liquibase.migrate-at-start=true
quarkus.liquibase.validate-on-migrate=true</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The parameter <code>quarkus.hibernate-orm.log.sql</code> will activate the hibernate logs in the console.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="_database_schema_change_management"><a class="anchor" href="#_database_schema_change_management"></a>Database schema change management</h4>
<div class="paragraph">
<p><a href="https://www.liquibase.com/">Liquibase</a> is an open source tool for database schema change management. We will this framework in our example. Liquibase does have abstraction layer xml, json or yaml to support multi databases. Liquibase can generate the changes and compare our Hibernate model with existing database.</p>
</div>
<div class="paragraph">
<p>For the database schema change management we do use <a href="https://quarkus.io/guides/">quarkus-liquibase</a> extension. To generate a database changes or validate the database changes we do use <a href="https://github.com/1000kit/tkit-liquibase-plugin">tkit-liquibase-plugin</a> which is configured in the onecx-quarkus3-parent.</p>
</div>
<div class="paragraph">
<p>Quarkus liquibase configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.liquibase.migrate-at-start=true
quarkus.liquibase.validate-on-migrate=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, liquibase does not use session lock. To activate the liquibase session lock during the start of our service we do use <code>com.github.blagerweij:liquibase-sessionlock</code> liquibase extension. No configuration is need to this extension.</p>
</div>
<div class="paragraph">
<p>To generate the database changes run following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn clean compile -Pdb-diff</code></pre>
</div>
</div>
<div class="paragraph">
<p>To check if you are missing any changes run following command</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-shell hljs" data-lang="shell">mvn validate -Pdb-check</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jpa_date_time"><a class="anchor" href="#_jpa_date_time"></a>JPA date-time</h4>
<div class="paragraph">
<p>First, you need to configure the database server to use the UTC timezone. For example PostgreSQL default is UTC. Second, you need to set hibernate.jdbc.time_zone Hibernate property to the value of UTC. For the Quarkus application we need set key quarkus.hibernate-orm.jdbc.timezone to UTC value in the application.properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">quarkus.hibernate-orm.jdbc.timezone=UTC</code></pre>
</div>
</div>
<div class="paragraph">
<p>The date representation in the database is store in the UTC as long number. Date fields in the JPA entity represents this database date as LocalDateTime. On the another hand the DTO represents the date as ISO text. To get it running we need to create a mapper which will map the LocalDateTime to OffsetDatetime. In the mapping we should not lose the Offset/Zone information.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The date representation in the JPA entity is the LocalDateTime java type and in the DTO object is the OffsetDateTime java type.
</td>
</tr>
</table>
</div>
<details>
<summary class="title">Example user entity</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Entity
@Table(name = "T_USER")
public class User extends TraceableEntity {
    private String username;
    private LocalDateTime date;
}</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Example user DTO</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RegisterForReflection
public class UserDTO extends TraceableDTO {
    private String username;
    private OffsetDateTime date;
}</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">Example user mapper</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.tkit.quarkus.rs.mappers.OffsetDateTimeMapper;

@Mapper(uses = OffsetDateTimeMapper.class)
public interface UserMapper {

    UserDTO map(User model);

    User create(UserDTO dto);
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>In the tests we need to configure the RestAssured to use text representation of the date-time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public abstract class AbstractTest {
    static {
        RestAssured.config = RestAssuredConfig.config().objectMapperConfig(
            ObjectMapperConfig.objectMapperConfig().jackson2ObjectMapperFactory(
                (cls, charset) -&gt; {
                     ObjectMapper objectMapper = new ObjectMapper();
                     objectMapper.registerModule(new JavaTimeModule());
                     objectMapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);
                     return objectMapper;
                }
            )
        );
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jpa_custom_business_id"><a class="anchor" href="#_jpa_custom_business_id"></a>JPA custom business ID</h3>
<div class="sect3">
<h4 id="_postgressql_serial_type"><a class="anchor" href="#_postgressql_serial_type"></a>PostgresSQL SERIAL type</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GeneratorType(type = BidStringGenerator.class, when = GenerationTime.INSERT)
@Column(name = "CUSTOM")
String custom;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_generic_sequence_implementation"><a class="anchor" href="#_generic_sequence_implementation"></a>Generic sequence implementation</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import javax.persistence.Column;
import org.my.group.BusinessId;

@BusinessId(sequence = "SEQ_MY_ENTITY_BID")
@Column(name = "bid_anno")
Long bid;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the implementation of the custom annotation <code>BusinessId</code>.</p>
</div>
<details>
<summary class="title">BusinessId</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.hibernate.annotations.ValueGenerationType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;

@ValueGenerationType(generatedBy = BusinessIdValueGeneration.class)
@Retention(RetentionPolicy.RUNTIME)
public @interface BusinessId {

    String sequence() default "";

}</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">BusinessIdValueGeneration</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.hibernate.tuple.AnnotationValueGeneration;
import org.hibernate.tuple.GenerationTiming;
import org.hibernate.tuple.ValueGenerator;

public class BusinessIdValueGeneration implements AnnotationValueGeneration&lt;BusinessId&gt; {

    String sequence;

    @Override
    public void initialize(BusinessId annotation, Class&lt;?&gt; propertyType) { sequence = annotation.sequence(); }

    @Override
    public GenerationTiming getGenerationTiming() { return GenerationTiming.INSERT; }

    @Override
    public ValueGenerator&lt;?&gt; getValueGenerator() { return new BusinessIdGenerator(sequence); }

    @Override
    public boolean referenceColumnInSql() { return false; }

    @Override
    public String getDatabaseGeneratedReferencedColumnValue() { return null; }
}</code></pre>
</div>
</div>
</div>
</details>
<details>
<summary class="title">BusinessIdGenerator</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.hibernate.Session;
import org.hibernate.internal.SessionFactoryImpl;
import org.hibernate.jdbc.ReturningWork;
import org.hibernate.tuple.ValueGenerator;

import java.sql.PreparedStatement;
import java.sql.ResultSet;


public class BusinessIdGenerator implements ValueGenerator&lt;Long&gt; {

    String sequence;

    BusinessIdGenerator(String sequence) {
        this.sequence = sequence;
    }

    @Override
    public Long generateValue(Session session, Object owner) {
        SessionFactoryImpl sessionFactory = (SessionFactoryImpl) session.getSessionFactory();
        String sql = sessionFactory.getJdbcServices().getDialect().getSequenceNextValString(sequence);
        ReturningWork&lt;Long&gt; seq = connection -&gt; {
            try (PreparedStatement preparedStatement = connection.prepareStatement(sql);
                 ResultSet resultSet = preparedStatement.executeQuery()) {
                resultSet.next();
                return resultSet.getLong(1);
            }
        };
        return sessionFactory.getCurrentSession().doReturningWork(seq);
    }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>We need to add the sequence to the <code>import.sql</code> for the local development.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE SEQUENCE IF NOT EXISTS seq_my_entity_bid;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_custom_in_memory_generator"><a class="anchor" href="#_custom_in_memory_generator"></a>Custom in-Memory generator</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@GeneratorType(type = BidStringGenerator.class, when = GenerationTime.INSERT)
@Column(name = "CUSTOM")
String custom;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the implementation of the custom generator <code>BidStringGenerator</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class BidStringGenerator implements ValueGenerator&lt;String&gt; {

    @Override
    public String generateValue(Session session, Object owner) {
        MyEntity e = (MyEntity) owner;
        return e.name + "+" + UUID.randomUUID();
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_tests"><a class="anchor" href="#_tests"></a>Tests</h3>
<div class="paragraph">
<p>For the test we add following dependencies to our project</p>
</div>
<details>
<summary class="title">Test dependencies</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;!-- TEST --&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;quarkus-junit5&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.rest-assured&lt;/groupId&gt;
        &lt;artifactId&gt;rest-assured&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
        &lt;artifactId&gt;tkit-quarkus-test-db-import&lt;/artifactId&gt;
        &lt;scope&gt;test&lt;/scope&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</details>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The Quarkus tests has support for the injection and mocking. This will work only for the Quarkus JVM tests and not for native image test or integration tests with a docker image. Try to avoid this in our tests to have much more reusable tests. In most cases, the mock service also fakes code to pass the test.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For our test we will use this pattern for the test classes</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;Name&gt;RestControllerTest extends AbstractTest</code> - the extended test for the common and unit test. For example: UserRestControllerTest</p>
</li>
<li>
<p><code>&lt;Name&gt;RestControllerTestIT extends &lt;Name&gt;RestControllerTest</code> - the extended test for the integration test. For example: UserRestControllerTestIT</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The 1000kit test extension <code>tkit-quarkus-test-db-import</code> does have support to import test data for the tests during the test execution. We will create our test data as <code>XML</code> data. Store the xml file in the <code>src/test/resources/data</code> directory under name <code>test-internal.xml</code>. The magic is in the <code>@WithDBData</code> annotation which could be used on the <code>Class</code> or <code>Method</code> level. Example of the xml test data file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;dataset&gt;
    &lt;ROLE guid="r21" optlock="0" name="n1" /&gt;
    &lt;ROLE guid="r22" optlock="0" name="n2" /&gt;
&lt;/dataset&gt;</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Only the <code>XML</code> DbUnit <code>FlatXmlDataSet</code> format is supported.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Example of the <code>RoleRestControllerTest</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@TestHTTPEndpoint(RoleRestController.class)
@WithDBData(value = "data/test-internal.xml", deleteBeforeInsert = true, deleteAfterTest = true, rinseAndRepeat = true)
class RoleRestControllerTest extends AbstractTest {

    @Test
    void getRoleByIdTest() {

        // get role by ID
        var dto = given().contentType(APPLICATION_JSON).get("r12")
                .then().statusCode(OK.getStatusCode()).contentType(APPLICATION_JSON)
                .extract().body().as(RoleDTO.class);

        // validate role
        assertThat(dto).isNotNull();
        assertThat(dto.getName()).isEqualTo("n2");
        assertThat(dto.getId()).isEqualTo("r12");

        // not found
        given().contentType(APPLICATION_JSON).get("___").then().statusCode(NOT_FOUND.getStatusCode());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of the role rest controller integration test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import io.quarkus.test.junit.QuarkusIntegrationTest;

@QuarkusIntegrationTest
class RoleRestControllerTestIT extends RoleRestControllerTest {

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_security"><a class="anchor" href="#_security"></a>Security</h3>
<div class="paragraph">
<p>To enable scope security for backend services we need to add these Maven dependencies.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;quarkus-oidc&lt;/artifactId&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.tkit.onecx.quarkus&lt;/groupId&gt;
        &lt;artifactId&gt;onecx-security&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next step is to add the <code>OAuth</code> scopes to our OpenApi definition. In our example, we add the <code>read</code> scope to the <code>createRole</code> method.</p>
</div>
<details>
<summary class="title">Example openapi with scope</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">openapi: 3.0.3
info:
  title: example service
  version: 1.0.0
servers:
  - url: "http://onecx-example-svc:8080"
paths:
  /internal/roles:
    get:
      security:
        - oauth2: [read]
      operationId: createRole
      responses:
        201:
          description: "Role created"
components:
  securitySchemes:
    oauth2:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: https://oauth.simple.api/token
          scopes:
            read: Grants read access</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Now we need to add the extension <code>org.tkit.onecx.quarkus:onecx-openapi-generator</code> which will generate the Quarkus annotation <code>@io.quarkus.security.PermissionsAllowed</code> for the security interceptor from our open API definition file. We add this extension as a dependency for the Maven plugin <code>org.openapitools:openapi-generator-maven-plugin</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;org.openapitools&lt;/groupId&gt;
    &lt;artifactId&gt;openapi-generator-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
        &lt;additionalProperties&gt;onecx-scopes=true&lt;/additionalProperties&gt;
        &lt;!-- configuration --&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;&lt;!-- executions --&gt;&lt;/executions&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.onecx.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;onecx-openapi-generator&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable this extension, we also need to define additional properties <code>onecx-scopes=true</code>. Without this configuration, the generator uses the default Java source code template.</p>
</div>
<div class="paragraph">
<p>Now our generated source code contains the annotation <code>@io.quarkus.security.PermissionsAllowed({"read"})</code> to the generated method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public interface RoleInternalApi {

    @io.quarkus.security.PermissionsAllowed({ "read" })
    @GET
    @Consumes({ "application/json" })
    @Produces({ "application/json" })
    Response createRole();

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>org.tkit.onecx.quarkus:onecx-security</code> extension creates security audit data for the default Quarkus security extension during the build process. After enabling this extension, it is no longer possible to call this method without a token and with the scope <code>read</code>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
To disable security setup following property <code>tkit.security.auth.enabled=false</code>. This property is part fo (tkit-quarkus-url)[1000kit Quarkus extension]
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_security_tests"><a class="anchor" href="#_security_tests"></a>Security tests</h3>
<div class="paragraph">
<p>For testing we use Quarkus <code>Keycloak</code> dev services. To activate this feature add this maven dependency.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;io.quarkus&lt;/groupId&gt;
    &lt;artifactId&gt;quarkus-test-keycloak-server&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Quarkus will start and configure a <code>Keycloak</code> server for our tests but also in the dev mode by default. Now we can configure <code>user</code> and they <code>roles</code>.
For example, we add role <code>role-admin</code> to user <code>alice</code> in our example</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># Enabled security for all requests /* and exclude /q/* quarkus console
quarkus.http.auth.permission.health.paths=/q/*
quarkus.http.auth.permission.health.policy=permit
quarkus.http.auth.permission.default.paths=/*
quarkus.http.auth.permission.default.policy=authenticated

# TEST
%test.quarkus.keycloak.devservices.roles.alice=role-admin
%test.quarkus.keycloak.devservices.roles.bob=role-user

# DEV
%dev.quarkus.keycloak.devservices.roles.alice=role-admin
%dev.quarkus.keycloak.devservices.roles.bob=role-user</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
How to import the whole realm or configure additional user in to <code>Keycloak</code> dev services please check the <a href="https://quarkus.io/guides/">Quarkus documentation</a> page.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can use the <code>io.quarkus.test.keycloak.client.KeycloakTestClient</code> in our test.</p>
</div>
<details open>
<summary class="title">Example test class</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@TestHTTPEndpoint(RoleRestController.class)
class RoleRestControllerTest {

    // create keycloak client instance connected to keycloak dev service container
    KeycloakTestClient keycloakClient = new KeycloakTestClient();

     @Test
    void oauthTest() {
         // get the access token of the user alice
        var token = keycloakClient.getAccessToken("alice");

        // call rest endpoint
        given().when()
                .auth().oauth2(token)
                .contentType(APPLICATION_JSON).get("1").then()
                .statusCode(Response.Status.OK.getStatusCode());

        // test without oauth token
        given().when().contentType(APPLICATION_JSON).get("1").then()
                .statusCode(Response.Status.UNAUTHORIZED.getStatusCode());
    }
}</code></pre>
</div>
</div>
</div>
</details>
</div>
<div class="sect2">
<h3 id="_multi_tenancy"><a class="anchor" href="#_multi_tenancy"></a>Multi tenancy</h3>
<div class="paragraph">
<p>For multi tenancy we will to use <a href="https://onecx.github.io/docs/onecx-quarkus/current/onecx-quarkus/index.html">onecx-quarkus-tenant</a> extension.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
For more information about the configuration please check the documentation page <a href="https://onecx.github.io/docs/onecx-quarkus/current/onecx-quarkus/index.html">onecx-quarkus-tenant</a>
</td>
</tr>
</table>
</div>
<details>
<summary class="title">Multi tenancy maven dependencies</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependencies&gt;
        &lt;!-- ONECX --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.onecx.quarkus&lt;/groupId&gt;
            &lt;artifactId&gt;onecx-tenant&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 1000kit --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.tkit.quarkus.lib&lt;/groupId&gt;
            &lt;artifactId&gt;tkit-quarkus-jpa&lt;/artifactId&gt;
        &lt;/dependency&gt;
&lt;/dependencies&gt;</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Now we need to configure our application</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties"># hibernate multi-tenant configuration
quarkus.hibernate-orm.multitenant=DISCRIMINATOR

# enable or disable multi-tenancy support
tkit.rs.context.tenant-id.enabled=true</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Header configuration for the token, and token parsing is implemented in 1000kit <a href="https://1000kit.github.io/tkit-quarkus/current/tkit-quarkus/index.html">tkit-rest-context</a> quarkus extensions. Please check the documentation of the extension.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_multi_tenancy_tests"><a class="anchor" href="#_multi_tenancy_tests"></a>Multi tenancy tests</h3>
<div class="paragraph">
<p>For the test we can use mock settings where we can define which claim attribute of the token we will use: <code>%test.tkit.rs.context.tenant-id.mock.claim-org-id=orgId</code> and we must define mapping between token claim value and tenant ID <code>%test.tkit.rs.context.tenant-id.mock.data.&lt;claim-value&gt;=&lt;tenant-id&gt;</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">%test.tkit.rs.context.tenant-id.enabled=true
%test.tkit.rs.context.tenant-id.mock.enabled=true
%test.tkit.rs.context.tenant-id.mock.default-tenant=default
%test.tkit.rs.context.tenant-id.mock.claim-org-id=orgId
%test.tkit.rs.context.tenant-id.mock.data.org1=tenant-100
%test.tkit.rs.context.tenant-id.mock.data.org2=tenant-200</code></pre>
</div>
</div>
<div class="paragraph">
<p>For the test we can create a simple help method which will creates a token for our tests</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@SuppressWarnings("java:S2187")
public class AbstractTest {

    // header ID of the principal token for tests
    protected static final String APM_HEADER_PARAM = "apm-principal-token";

    // token claim for tenant-id
    protected static final String CLAIMS_ORG_ID = ConfigProvider.getConfig()
            .getValue("%test.tkit.rs.context.tenant-id.mock.claim-org-id", String.class);

   /**
    * Method creates a principal token for test.
    * @param organizationId organization ID
    * @return the corresponding test
    */
    protected static String createToken(String organizationId) {
        try {
            String userName = "test-user";
            JsonObjectBuilder claims = Json.createObjectBuilder();
            claims.add(Claims.preferred_username.name(), userName);
            claims.add(Claims.sub.name(), userName);
            claims.add(CLAIMS_ORG_ID, organizationId);
            PrivateKey privateKey = KeyUtils.generateKeyPair(2048).getPrivate();
            return Jwt.claims(claims.build()).sign(privateKey);
        } catch (Exception ex) {
            throw new RuntimeException(ex);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In our test we can use <code>createToken</code> method to create a token</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QuarkusTest
@TestHTTPEndpoint(ExampleRestController.class)
class ExampleRestControllerTenantTest extends AbstractTest {

    @Test
    void createNewThemeTest() {
        var dto = given()
                .when()
                .contentType(APPLICATION_JSON)
                .header(APM_HEADER_PARAM, createToken("org1"))
                .body(themeDto)
                .post()
                .then()
                .statusCode(CREATED.getStatusCode())
                .extract()
                .body().as(ExampleDTO.class);
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
  </article>  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script>
    document.addEventListener('readystatechange', event => {
    if (event.target.readyState === "complete") {
        renderAllBpmnJs();
    }
    });    
</script>
  </body>
</html>
